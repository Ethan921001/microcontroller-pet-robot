#include <xc.h>
#include <stdint.h> // ????????

#define _XTAL_FREQ 250000  // ?? 250 kHz
#define I2C_CLOCK 100000   // I2C ?? 100 kHz
#define OLED_I2C_ADDRESS 0x3C // OLED ? I2C ?? (7 ?)

#pragma config FOSC = INTRC_NOCLKOUT    // ????RC???????????
#pragma config WDTE = OFF               // ????????
#pragma config PWRTE = ON               // ?????????
#pragma config MCLRE = ON               // ?? MCLR ??
#pragma config LVP = OFF                // ???????

// I2C ?????
void I2C1_Initialize(void) {
    SSPCON1 = 0x28;  // ?? I2C ??????? MSSP ??
    SSPSTAT = 0x00;  // ??????
    SSPADD = (_XTAL_FREQ / (4 * I2C_CLOCK)) - 1; // ?????
}

// I2C ????
void I2C1_Start(void) {
    SSPCON2bits.SEN = 1;  // ??????
    while (SSPCON2bits.SEN); // ????
}

// I2C ????
void I2C1_Stop(void) {
    SSPCON2bits.PEN = 1;  // ??????
    while (SSPCON2bits.PEN); // ????
}

// I2C ????
void I2C1_Write(uint8_t data) {
    SSPBUF = data;       // ????
    while (SSPSTATbits.BF); // ???????
    while (SSPCON2bits.ACKSTAT); // ??????? (ACK)
}

// OLED ????
void OLED_Command(uint8_t cmd) {
    I2C1_Start();
    I2C1_Write(OLED_I2C_ADDRESS << 1); // ???
    I2C1_Write(0x00); // ????: Co = 0, D/C# = 0
    I2C1_Write(cmd);
    I2C1_Stop();
}

// OLED ???
void OLED_Initialize(void) {
    OLED_Command(0xAE); // ????
    OLED_Command(0x20); // ????????
    OLED_Command(0x10); // ??????
    OLED_Command(0xB0); // ??????
    OLED_Command(0xC8); // COM ????
    OLED_Command(0x00); // ??????
    OLED_Command(0x10); // ??????
    OLED_Command(0x40); // ???????
    OLED_Command(0x81); // ???????
    OLED_Command(0xFF); // ?????
    OLED_Command(0xA1); // ????
    OLED_Command(0xA6); // ??????
    OLED_Command(0xA8); // ????????
    OLED_Command(0x3F); // 1/64 ????
    OLED_Command(0xD3); // ????
    OLED_Command(0x00); // ???
    OLED_Command(0xD5); // ???????
    OLED_Command(0x80); // ????
    OLED_Command(0xD9); // ?????
    OLED_Command(0xF1); // ??1???2??
    OLED_Command(0xDA); // COM ??????
    OLED_Command(0x12); // ?? COM ????
    OLED_Command(0xDB); // Vcomh ?????
    OLED_Command(0x40); // ???
    OLED_Command(0xA4); // ??????
    OLED_Command(0xAF); // ????
}

// OLED ????
void OLED_Data(uint8_t data) {
    I2C1_Start();
    I2C1_Write(OLED_I2C_ADDRESS << 1); // ???
    I2C1_Write(0x40); // ????: Co = 0, D/C# = 1
    I2C1_Write(data);
    I2C1_Stop();
}

// ?????? (5x8 ??)
const uint8_t font[96][5] = {
    {0x00, 0x00, 0x00, 0x00, 0x00}, // ??
    {0x00, 0x00, 0x5F, 0x00, 0x00}, // '!'
    {0x00, 0x07, 0x00, 0x07, 0x00}, // '"'
    // ?????????...
};

// ????
void OLED_PrintChar(char c) {
    for (int i = 0; i < 5; i++) {
        OLED_Data(font[c - ' '][i]); // ????????
    }
    OLED_Data(0x00); // ????
}

// ???
void main(void) {
    I2C1_Initialize();  // ??? I2C
    OLED_Initialize();  // ??? OLED

    while (1) {
        OLED_Command(0xB0); // ?????
        OLED_Command(0x00); // ??????
        OLED_Command(0x10); // ??????

        OLED_PrintChar('A'); // ???? 'A'
        __delay_ms(1000); // ?? 1 ?
    }
}
